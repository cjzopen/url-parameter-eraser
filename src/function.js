window.defaultParams = [
  { param: '^utm_', note: '', domain: '' },
  { param: '^stm_', note: '', domain: '' },
  { param: '_gl', note: 'Google Analytics', domain: '' },
  { param: '_ga', note: 'Google Analytics', domain: '' },
  { param: '^__hs', note: 'hubspot', domain: '' },
  { param: '^_hs', note: 'hubspot', domain: '' },
  { param: '^hsa_', note: 'hubspot', domain: '' },
  { param: 'icid', note: '', domain: '' },
  { param: 'igshid', note: '', domain: '' },
  { param: 'ocid', note: '', domain: '' },
  { param: '^mc_', note: '', domain: '' },
  { param: 'mkt_tok', note: '', domain: '' },
  { param: 'fbclid', note: 'facebook', domain: '' },
  { param: 'yclid', note: '', domain: '' },
  { param: '_openstat', note: '', domain: '' },
  { param: 'wicked', note: '', domain: '' },
  { param: 'jobsource', note: '104', domain: '' },
  { param: 'xmt', note: 'Threads', domain: '' },
  { param: 'otc', note: '', domain: '' },
  { param: '^oly_', note: '', domain: '' },
  { param: 'rb_clickid', note: '', domain: '' },
  { param: '^soc_', note: '', domain: '' },
  { param: 'cvid', note: '', domain: '' },
  { param: 'oicd', note: '', domain: '' },
  { param: 'vgo_ee', note: '', domain: '' },
  { param: 'gs_lcrp', note: '', domain: '' },
  { param: 'gclid', note: 'google ads', domain: '' },
  { param: 'gad_source', note: 'google ads', domain: '' },
  { param: 'gad_campaignid', note: 'google ads', domain: '' },
  { param: 'gbraid', note: 'google ads', domain: '' },
  { param: 'trackingId', note: '', domain: '' },
  { param: 'srsltid', note: 'google merchant center', domain: '' },
  { param: 'sxsrf', note: 'google search', domain: '' },
  { param: 'gs_lp', note: '', domain: '' },
  { param: 'ved', note: 'google search', domain: '' },
  { param: 'gs_ssp', note: 'google search', domain: '' },
  { param: 'sca_esv', note: 'google search', domain: '' },
  { param: '^ref_', note: 'twitter, google', domain: '' },
  { param: '$deep_link', note: 'reddit', domain: '' },
  { param: '$3p', note: 'reddit', domain: '' },
  { param: 'correlation_id', note: 'reddit', domain: '' },
  { param: 'post_fullname', note: 'reddit', domain: '' },
  { param: '_branch_match_id', note: '', domain: '' },
  { param: '_branch_referrer', note: '', domain: '' },
  { param: 'trk', note: 'linkedin', domain: '' },
  { param: 'mcid', note: '', domain: '' },
  { param: 'upsellOrderOrigin', note: 'linkedin', domain: '' },
  { param: 'referenceId', note: 'linkedin', domain: '' },
  { param: 'miniProfileUrn', note: 'linkedin', domain: '' },
  { param: 'lipi', note: 'linkedin', domain: '' },
  { param: 'trkEmail', note: 'linkedin', domain: '' },
  { param: 'midSig', note: 'linkedin', domain: '' },
  { param: 'midToken', note: 'linkedin', domain: '' },
  { param: 'otpToken', note: 'linkedin', domain: '' },
  { param: 'msclkid', note: '', domain: '' },
  { param: 'rlid', note: '', domain: '' },
  { param: 'fr2', note: 'bing or yahoo', domain: '' },
  { param: 'refId', note: 'bing or yahoo', domain: '' },
  { param: '^attr_', note: 'bing or yahoo', domain: '' },
  { param: '_source_', note: '', domain: '' },
  { param: 'is_from_webapp', note: '', domain: '' },
  { param: 'sender_device', note: '', domain: '' },
  { param: 'adgrpid', note: 'amazon', domain: '' },
  { param: '^hv', note: 'amazon', domain: 'amazon.com' },
  { param: 'hydadcr', note: 'amazon', domain: '' },
  { param: '^pd_rd_', note: 'amazon', domain: '' },
  { param: '^pf_rd_', note: 'amazon', domain: '' },
  { param: 'content-id', note: '', domain: 'amazon.com' },
  { param: 'dib', note: 'amazon', domain: '' },
  { param: 'dib_tag', note: 'amazon', domain: '' },
  { param: 'qid', note: 'amazon', domain: '' },
  { param: 'sp_csd', note: 'amazon', domain: '' },
  { param: 'rh', note: '', domain: 'amazon.com' },
  { param: 'rdt_cid', note: '', domain: '' },
  { param: 'li_fat_id', note: 'LinkedIn ad', domain: '' },
  { param: '^highlightedUpdate', note: '', domain: '' },
  { param: 'fingerprint', note: '', domain: '' },
  { param: 'attemptId', note: '', domain: '' },
  { param: 'buvid', note: 'bilibili', domain: '' },
  { param: 'from_spmid', note: 'bilibili', domain: '' },
  { param: '^share_', note: 'bilibili', domain: '' },
  { param: 'spmid', note: 'bilibili', domain: '' },
  { param: 'unique_k', note: 'bilibili', domain: '' },
  { param: 'up_id', note: 'bilibili', domain: '' },
  { param: 'vd_source', note: 'bilibili', domain: '' },
  { param: 'is_story_h5', note: 'bilibili', domain: '' },
  { param: 'mid', note: 'bilibili', domain: '' },
  { param: 'entry-point', note: 'uber', domain: '' },
  { param: 'access-point', note: 'uber', domain: '' },
  { param: 'pass-campaign', note: 'uber', domain: '' },
  { param: '$deeplink_path', note: 'uber', domain: '' },
  { param: 'itmmeta', note: 'ebay', domain: '' },
  { param: 'itmprp', note: 'ebay', domain: '' },
  { param: '_trksid', note: 'ebay', domain: '' },
  { param: 'hash', note: 'ebay', domain: 'ebay.com' },
  { param: 'af_xp', note: '', domain: '' },
  { param: 'shortlink', note: '', domain: '' },
  { param: 'fbid', note: '', domain: '' },
  { param: '^__cft__', note: 'facebook', domain: '' },
  { param: '__tn__', note: 'facebook', domain: '' },
  { param: '^itm_', note: '', domain: '' }
];

// 從 storage 中獲取參數
function getStoredParams(keys, callback) {
  chrome.storage.sync.get(keys, callback);
}

// 儲存參數到 storage
function saveParams(key, params, callback) {
  chrome.storage.sync.set({ [key]: params }, callback);
}

// 創建參數列表項
function createParamsListElement(el, paramObj, isDefault, deleteCallback) {
  const li = document.createElement('li');
  let param, note, domain;
  if (typeof paramObj === 'string') {
    param = paramObj;
    note = '';
    domain = '';
  } else {
    param = paramObj.param;
    note = paramObj.note || '';
    domain = paramObj.domain || '';
  }

  // popoverId 只允許 _, -, 英文
  const safeParamIdName = param.replace(/[^a-zA-Z_-]/g, '');
  const popoverId = `param-${safeParamIdName}`;

  // Popover 按鈕
  const popoverBtn = document.createElement('button');
  popoverBtn.textContent = param;
  popoverBtn.setAttribute('popovertarget', popoverId);
  popoverBtn.classList.add('paramsListPopover');
  li.appendChild(popoverBtn);

  // Popover 內容
  const popDiv = document.createElement('div');
  popDiv.setAttribute('popover', '');
  popDiv.id = popoverId;
  const infoDiv = document.createElement('div');
  infoDiv.style.display = 'flex';
  infoDiv.style.flexDirection = 'column';
  infoDiv.style.gap = '8px';

  // Popover 關閉按鈕（SVG）
  const closeBtn = document.createElement('button');
  closeBtn.setAttribute('popovertarget', popoverId);
  closeBtn.type = 'button';
  closeBtn.style.alignSelf = 'flex-end';
  closeBtn.style.background = 'none';
  closeBtn.style.border = 'none';
  closeBtn.style.cursor = 'pointer';
  closeBtn.style.padding = '0';
  // SVG內容
  closeBtn.innerHTML = '<svg width="24" height="24" viewBox="0 0 512 512" fill="currentColor"><use href="#svg-close-button"></use></svg>';
  infoDiv.appendChild(closeBtn);

  infoDiv.innerHTML += `<b>${param}</b>`;
  if (note) infoDiv.innerHTML += `<div>Note: ${note}</div>`;
  if (domain) infoDiv.innerHTML += `<div>Domain: ${domain}</div>`;
  const deleteButton = document.createElement('button');
  deleteButton.innerHTML = '<svg width="28" height="32" viewBox="0 0 448 512" fill="currentColor"><use href="#svg-delete-button"></use></svg>';
  deleteButton.style.color = '#ff2453';
  deleteButton.title = `DELETE ${param}`;
  deleteButton.style.marginTop = '60px';
  deleteButton.addEventListener('click', () => deleteCallback(param));
  infoDiv.appendChild(deleteButton);
  popDiv.appendChild(infoDiv);
  li.appendChild(popDiv);

  return li;
}

// 更新參數列表的 DOM（支援 customParams 物件格式）
function updateParamsList(paramsListElement, defaultParams, customParams, deleteDefaultParam, deleteCustomParam) {
  // 清空列表
  while (paramsListElement.firstChild) {
    paramsListElement.removeChild(paramsListElement.firstChild);
  }

  // 顯示 defaultParams
  defaultParams.forEach(param => {
    const li = createParamsListElement(paramsListElement, param, true, deleteDefaultParam);
    paramsListElement.appendChild(li);
  });

  // customParams 兼容字串與物件格式
  customParams.forEach(paramObj => {
    // 若缺 domain 欄位，自動補空字串
    if (typeof paramObj === 'object' && !('domain' in paramObj)) paramObj.domain = '';
    const li = createParamsListElement(paramsListElement, paramObj, false, deleteCustomParam);
    paramsListElement.appendChild(li);
  });
}

// 兼容舊格式 defaultParams：若為字串自動轉換為物件格式
function normalizeDefaultParams(arr) {
  return arr.map(p => {
    if (typeof p === 'string') return { param: p, note: '', domain: '' };
    if (!('note' in p)) p.note = '';
    if (!('domain' in p)) p.domain = '';
    return p;
  });
}

// 將文字轉義為正則表達式安全的格式
function escapeRegex(input) {
  if (typeof input !== 'string') input = input && input.param ? input.param : '';
  if (input.startsWith('^')) {
    return '^' + input.slice(1).replace(/[.*+?^${}()|[\\]\\]/g, '\\$&');
  }
  return input.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&');
}
